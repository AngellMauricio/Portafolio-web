let skip = 0;
const limit = 10;
let totalProductos = 0;

const cuerpoTabla = document.getElementById("cuerpoTabla");
const categoriaSelect = document.getElementById("categoriaSelect");
const ordenarSelect = document.getElementById("ordenarSelect");
const busquedaInput = document.getElementById("busqueda");

// Cargar categorías al inicio
const cargarCategorias = async () => {
    const res = await fetch('https://dummyjson.com/products/category-list');
    const categorias = await res.json();
    categorias.forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        categoriaSelect.appendChild(opt);
    });
};

const cargarProductos = async () => {
    cuerpoTabla.innerHTML = "<tr><td colspan='5'>Cargando...</td></tr>";
    
    const query = busquedaInput.value;
    const cat = categoriaSelect.value;
    const [sortBy, order] = ordenarSelect.value.split('-');

    let url = `https://dummyjson.com/products?limit=${limit}&skip=${skip}&sortBy=${sortBy}&order=${order}`;
    
    if (query) {
        url = `https://dummyjson.com/products/search?q=${query}&limit=${limit}&skip=${skip}`;
    } else if (cat) {
        url = `https://dummyjson.com/products/category/${cat}?limit=${limit}&skip=${skip}&sortBy=${sortBy}&order=${order}`;
    }

    try {
        const res = await fetch(url);
        const data = await res.json();
        totalProductos = data.total;
        renderizarTabla(data.products);
        actualizarInterfazPaginacion();
    } catch (err) { console.error(err); }
};

const renderizarTabla = (productos) => {
    cuerpoTabla.innerHTML = "";
    productos.forEach(p => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${p.id}</td>
            <td><img src="${p.thumbnail}" width="50"></td>
            <td>${p.title}</td>
            <td>$${p.price}</td>
            <td>
                <a href="editar.html?id=${p.id}" class="btn-edit" style="text-decoration:none; padding:5px 10px; background:#e0f2fe; color:#0369a1; border-radius:4px;">Editar</a>
                <button class="btn-delete" onclick="eliminarProducto(${p.id}, this)" style="padding:5px 10px; background:#fee2e2; color:#b91c1c; border:none; cursor:pointer; border-radius:4px;">Eliminar</button>
            </td>
        `;
        cuerpoTabla.appendChild(tr);
    });
};

// ELIMINAR (Simulado, ya que la API no permite eliminar realmente)
window.eliminarProducto = async (id, boton) => {
    if (confirm(`¿Seguro que deseas eliminar el producto #${id}?`)) {
        const res = await fetch(`https://dummyjson.com/products/${id}`, { method: 'DELETE' });
        if (res.ok) {
            alert("Producto eliminado (Simulado)");
            boton.closest("tr").remove();
        }
    }
};

const actualizarInterfazPaginacion = () => {
    const pagActual = Math.floor(skip / limit) + 1;
    document.getElementById("pageInfo").innerText = `Página ${pagActual}`;
    document.getElementById("prevBtn").disabled = skip === 0;
    document.getElementById("nextBtn").disabled = (skip + limit) >= totalProductos;
};

// Eventos
document.getElementById("nextBtn").onclick = () => { skip += limit; cargarProductos(); };
document.getElementById("prevBtn").onclick = () => { skip -= limit; cargarProductos(); };
categoriaSelect.onchange = () => { skip = 0; cargarProductos(); };
ordenarSelect.onchange = () => { cargarProductos(); };
busquedaInput.onkeypress = (e) => { if(e.key === 'Enter') { skip = 0; cargarProductos(); } };

cargarCategorias();
cargarProductos();